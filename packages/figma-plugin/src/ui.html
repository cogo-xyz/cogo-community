<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cogo UUI Converter</title>
    <style>
      body { font: 13px -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin: 12px; }
      input { width: 100%; margin: 4px 0 8px; padding: 6px; }
      button { width: 100%; padding: 8px; }
      pre { background: #f6f8fa; padding: 8px; height: 200px; overflow: auto; }
      .ok { color: #0a0; }
      .fail { color: #a00; }
    </style>
  </head>
  <body>
    <label>Supabase Edge URL</label>
    <input id="edge" placeholder="https://xxx.functions.supabase.co" />
    <label>Anon Key</label>
    <input id="anon" placeholder="anon key" />
    <label>Project ID</label>
    <input id="projectId" placeholder="project uuid" />
    <button id="run">Convert Selection â†’ UUI & Cogo</button>
    <hr />
    <label>Ingest (large JSON)</label>
    <input id="fileName" placeholder="figma_*.json (optional)" />
    <textarea id="json" placeholder='Optional custom JSON to upload; leave empty to use selection' style="width:100%;height:120px"></textarea>
    <button id="ingest">Upload & Ingest</button>
    <div id="status"></div>
    <div id="actions" style="display:none; margin:8px 0;">
      <button id="openUrl" style="margin-right:6px;">Open Artifact</button>
      <button id="copyUrl" style="margin-right:6px;">Copy URL</button>
      <button id="copyKey" style="margin-right:6px;">Copy Key</button>
      <button id="copyTrace">Copy trace_id</button>
    </div>
    <pre id="out"></pre>
    <script>
      const $ = (id) => document.getElementById(id);
      // persist/load settings
      const keys = ['edge','anon','projectId'];
      try { const saved = JSON.parse(localStorage.getItem('cogo-plugin:settings')||'{}'); keys.forEach(k=>{ if(saved[k]) $(k).value = saved[k]; }); } catch {}

      document.getElementById('run').onclick = () => {
        parent.postMessage({ pluginMessage: { type: 'convert', payload: { edge: $('edge').value, anon: $('anon').value, projectId: $('projectId').value } } }, '*');
        try { localStorage.setItem('cogo-plugin:settings', JSON.stringify({ edge: $('edge').value, anon: $('anon').value, projectId: $('projectId').value })); } catch {}
        $('status').textContent = 'Running...';
      };
      document.getElementById('ingest').onclick = () => {
        parent.postMessage({ pluginMessage: { type: 'ingest', payload: { edge: $('edge').value, anon: $('anon').value, projectId: $('projectId').value, fileName: $('fileName').value, json: $('json').value } } }, '*');
        try { localStorage.setItem('cogo-plugin:settings', JSON.stringify({ edge: $('edge').value, anon: $('anon').value, projectId: $('projectId').value })); } catch {}
        $('status').textContent = 'Uploading & Ingesting...';
      };
      window.onmessage = (ev) => {
        const msg = ev.data.pluginMessage;
        if (!msg) return;
        if (msg.type === 'status') { $('status').textContent = msg.message; return; }
        if (msg.type === 'result') {
          $('status').textContent = msg.ok ? 'OK' : 'Failed';
          $('status').className = msg.ok ? 'ok' : 'fail';
          $('out').textContent = JSON.stringify(msg.json?.result || msg, null, 2);
          $('actions').style.display = 'none';
          return;
        }
        if (msg.type === 'ingest_result') {
          $('status').textContent = msg.ok ? 'Ready' : 'Failed';
          $('status').className = msg.ok ? 'ok' : 'fail';
          $('out').textContent = JSON.stringify(msg, null, 2);
          const signed = msg.signedUrl || '';
          const key = msg.key || '';
          const trace = msg.trace_id || '';
          $('actions').style.display = signed ? 'block' : 'none';
          $('openUrl').onclick = () => { if (signed) window.open(signed, '_blank'); };
          $('copyUrl').onclick = async () => { try { await navigator.clipboard.writeText(String(signed)); } catch {} };
          $('copyKey').onclick = async () => { try { await navigator.clipboard.writeText(String(key)); } catch {} };
          $('copyTrace').onclick = async () => { try { await navigator.clipboard.writeText(String(trace)); } catch {} };
          return;
        }
      };
    </script>
  </body>
  </html>


