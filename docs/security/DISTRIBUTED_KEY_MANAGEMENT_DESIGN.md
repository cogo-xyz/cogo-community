# ğŸ” ë¶„ì‚° Agent í™˜ê²½ì—ì„œì˜ API Key ê´€ë¦¬ ì„¤ê³„

## ğŸ¯ **ì„¤ê³„ ëª©í‘œ**

- **ì¤‘ì•™í™”ëœ Key ê´€ë¦¬**: ë‹¨ì¼ ì†ŒìŠ¤ì—ì„œ ëª¨ë“  Agentê°€ Key ì¡°íšŒ
- **ë™ì  Key ë¡œí…Œì´ì…˜**: ë¬´ì¤‘ë‹¨ Key ì—…ë°ì´íŠ¸
- **í´ë¼ìš°ë“œ Agnostic**: AWS, Azure, GCP, ê°œì¸ PC ëª¨ë‘ ì§€ì›
- **ì‹¤ì‹œê°„ ë™ê¸°í™”**: Supabase Realtimeì„ í†µí•œ ì¦‰ì‹œ ë°˜ì˜
- **ë³´ì•ˆ**: ì•”í˜¸í™”ëœ Key ì €ì¥ ë° ì „ì†¡

---

## ğŸ—ï¸ **Architecture 1: Supabase ì¤‘ì•™ Key Store**

### **êµ¬ì¡°**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Supabase Central                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   API Keys      â”‚    â”‚    Realtime Sync        â”‚ â”‚
â”‚  â”‚   (Encrypted)   â”‚â—„â”€â”€â–ºâ”‚   Key Updates           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Key Manager  â”‚ (New Service)
          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚             â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
â”‚Agent 1â”‚    â”‚Agent 2â”‚    â”‚Agent 3â”‚
â”‚AWS EC2â”‚    â”‚Azure  â”‚    â”‚ê°œì¸ PC â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Key Management Service êµ¬í˜„**

```typescript
// src/services/DistributedKeyManager.ts
export class DistributedKeyManager {
  private keyCache: Map<string, string> = new Map();
  private realtimeClient: SupabaseClient;
  
  async getApiKey(service: 'claude' | 'openai' | 'gemini' | 'fireworks' | 'deepinfra'): Promise<string> {
    // 1. ìºì‹œ í™•ì¸
    if (this.keyCache.has(service)) {
      return this.keyCache.get(service)!;
    }
    
    // 2. Supabaseì—ì„œ ì•”í˜¸í™”ëœ Key ì¡°íšŒ
    const encryptedKey = await this.fetchEncryptedKey(service);
    const decryptedKey = await this.decryptKey(encryptedKey);
    
    // 3. ìºì‹œ ì €ì¥
    this.keyCache.set(service, decryptedKey);
    return decryptedKey;
  }
  
  // Realtimeìœ¼ë¡œ Key ì—…ë°ì´íŠ¸ ìˆ˜ì‹ 
  subscribeToKeyUpdates(): void {
    this.realtimeClient
      .channel('api_keys_updates')
      .on('postgres_changes', 
        { event: 'UPDATE', schema: 'public', table: 'api_keys' },
        (payload) => this.handleKeyUpdate(payload)
      );
  }
}
```

---

## ğŸ—ï¸ **Architecture 2: HashiCorp Vault ë°©ì‹**

### **êµ¬ì¡°**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                HashiCorp Vault                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   KV Secrets    â”‚    â”‚    Dynamic Secrets      â”‚ â”‚
â”‚  â”‚   Engine        â”‚    â”‚    Auto-Rotation        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Agent Auth   â”‚ (JWT Token)
          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚             â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
â”‚Agent 1â”‚    â”‚Agent 2â”‚    â”‚Agent 3â”‚
â”‚ê°ìì˜  â”‚    â”‚Token  â”‚    â”‚ì¸ì¦   â”‚
â”‚ì¸ì¦    â”‚    â”‚ê¸°ë°˜   â”‚    â”‚ë°›ê³    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ **Architecture 3: Environment-Based with Git Ops**

### **êµ¬ì¡°**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Git Repository                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   env.secrets   â”‚    â”‚    deployment.yaml      â”‚ â”‚
â”‚  â”‚   (Encrypted)   â”‚    â”‚    (per environment)    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   CI/CD       â”‚ (Auto Deploy)
          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚             â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
â”‚Dev    â”‚    â”‚Stage  â”‚    â”‚Prod   â”‚
â”‚í™˜ê²½   â”‚    â”‚í™˜ê²½   â”‚    â”‚í™˜ê²½   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ **ê¶Œì¥: Hybrid ì ‘ê·¼ë²•**

### **Phase 1: Supabase ì¤‘ì•™ ê´€ë¦¬ (ì¦‰ì‹œ ì ìš©)**
```typescript
// ê¸°ì¡´ .env ë°©ì‹ì„ ì ì§„ì ìœ¼ë¡œ êµì²´
export class HybridKeyManager {
  async getApiKey(service: string): Promise<string> {
    // 1. í™˜ê²½ë³€ìˆ˜ ìš°ì„  (ê°œë°œìš©)
    const envKey = process.env[`${service.toUpperCase()}_API_KEY`];
    if (envKey && !envKey.startsWith('placeholder')) {
      return envKey;
    }
    
    // 2. Supabase ì¤‘ì•™ ì €ì¥ì†Œ (í”„ë¡œë•ì…˜ìš©)
    return await this.distributedKeyManager.getApiKey(service);
  }
}
```

### **Phase 2: Agent ìë™ ë“±ë¡ ë° Key í• ë‹¹**
```typescript
// Agentê°€ ì‹œì‘í•  ë•Œ ìë™ìœ¼ë¡œ Key ê¶Œí•œ ìš”ì²­
export class AgentBootstrap {
  async initialize(): Promise<void> {
    const agentId = this.generateAgentId();
    const keyPermissions = await this.requestKeyPermissions(agentId);
    this.keyManager.setPermissions(keyPermissions);
  }
}
```

---

## ğŸ”§ **êµ¬í˜„ ê³„íš**

### **Step 1: í˜„ì¬ ìƒíƒœ ìœ ì§€í•˜ë©´ì„œ ê¸°ë°˜ êµ¬ì¶•**
1. `DistributedKeyManager` ì„œë¹„ìŠ¤ ìƒì„±
2. Supabaseì— `api_keys` í…Œì´ë¸” ìƒì„±
3. ì•”í˜¸í™”/ë³µí˜¸í™” ë¡œì§ êµ¬í˜„

### **Step 2: ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜**
1. ê°œë°œ í™˜ê²½: ê¸°ì¡´ .env ë°©ì‹ ìœ ì§€
2. í”„ë¡œë•ì…˜ í™˜ê²½: Supabase ì¤‘ì•™ ê´€ë¦¬ë¡œ ì „í™˜
3. Realtime Key ì—…ë°ì´íŠ¸ êµ¬í˜„

### **Step 3: ê³ ê¸‰ ê¸°ëŠ¥ ì¶”ê°€**
1. Key ë¡œí…Œì´ì…˜ ìë™í™”
2. ì‚¬ìš©ëŸ‰ ê¸°ë°˜ Key ì„ íƒ
3. ì§€ì—­ë³„ Key ë¶„ì‚°

---

## ğŸ’¡ **ì¦‰ì‹œ ì ìš© ê°€ëŠ¥í•œ ê°œì„ ì•ˆ**

### **1. Key Validation Service**
```typescript
// ëª¨ë“  Agentê°€ ì‹œì‘ ì‹œ Key ìœ íš¨ì„± ê²€ì¦
export class KeyValidationService {
  async validateAllKeys(): Promise<KeyValidationResult> {
    const results = await Promise.all([
      this.validateClaude(),
      this.validateOpenAI(),
      this.validateGemini(),
      this.validateFireworks(),
      this.validateDeepInfra()
    ]);
    
    return this.aggregateResults(results);
  }
}
```

### **2. Agent Key Registry**
```typescript
// ì–´ë–¤ Agentê°€ ì–´ë–¤ Keyë¥¼ ì‚¬ìš©í•˜ëŠ”ì§€ ì¶”ì 
export class AgentKeyRegistry {
  private keyUsage: Map<string, Set<string>> = new Map();
  
  registerKeyUsage(agentId: string, service: string): void {
    // Key ì‚¬ìš©ëŸ‰ ì¶”ì  ë° ë¶„ì‚°
  }
}
```

---

## ğŸš€ **ë‹¹ì¥ ì ìš©í•  ìˆ˜ ìˆëŠ” ë°©ë²•**

í˜„ì¬ ìƒí™©ì—ì„œëŠ” **ì œê³µí•´ì£¼ì‹  ì‹¤ì œ Keyë“¤ì„ ì„¤ì •í•˜ë˜**, ë™ì‹œì— **ë¶„ì‚° Key ê´€ë¦¬ ê¸°ë°˜**ì„ êµ¬ì¶•í•˜ëŠ” ê²ƒì´ ì¢‹ê² ìŠµë‹ˆë‹¤.

1. **ì¦‰ì‹œ**: ì‹¤ì œ Keyë¡œ .env ì—…ë°ì´íŠ¸  
2. **ë³‘ë ¬**: `DistributedKeyManager` ì„œë¹„ìŠ¤ ê°œë°œ
3. **ì ì§„ì **: í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ ì¤‘ì•™ ê´€ë¦¬ë¡œ ì „í™˜

ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
